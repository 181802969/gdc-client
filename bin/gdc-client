#!/usr/bin/env python
import logging
import sys

from gdc_client.version import __version__ as version
from gdc_client.argparser import argparser, subparsers
from gdc_client import download, upload, interactive
from gdc_client.log import get_logger
from gdc_client.exceptions import ClientError

logging.root.setLevel(logging.INFO)
log = get_logger('gdc-client')


# TODO FIXME replace w/ updated email @ go live
SUPPORT_EMAIL = 'support@nci-gdc.datacommons.io'

ERROR_MSG = ' '.join([
    'An unexpected error has occurred during normal operation of the client.',
    'Please report the following exception to GDC support <{support_email}>.',
]).format(support_email=SUPPORT_EMAIL)


def log_version_header():
    log.info('gdc-client - {version}'.format(version=version))


if __name__ == '__main__':

    interactive_subparser = subparsers.add_parser('interactive',
        help='run in interactive mode',
    )
    interactive.parser.config(interactive_subparser)

    download_subparser = subparsers.add_parser('download',
        help='download data from the GDC',
    )
    download.parser.config(download_subparser)

    upload_subparser = subparsers.add_parser('upload',
        help='upload data to the GDC',
    )
    upload.parser.config(upload_subparser)

    args = argparser.parse_args()
    log_version_header()

    try:
        args.func(args)
    except ClientError as err:
        log.error(err)
        sys.exit(1)
    except KeyboardInterrupt:
        log.warning('Process cancelled by user.')
        sys.exit(130)
    except Exception as err:
        log.error(ERROR_MSG)
        log.exception(err)
        sys.exit(1)
    else:
        log.info('Completed successfully.')
